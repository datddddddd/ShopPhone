@model ShopPhone.Models.ProductFilterViewModel
@{
    ViewData["Title"] = "Danh sách sản phẩm";
    Layout = "_Layout";
}

<div class="container mt-4">
    <!-- Tiêu đề -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="text-center text-primary">
                <i class="fas fa-mobile-alt me-2"></i>Danh Sách Sản Phẩm
            </h2>
        </div>
    </div>

    <!-- Form tìm kiếm và lọc -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-search me-2"></i>Tìm kiếm và lọc sản phẩm</h5>
                </div>
                <div class="card-body">
                    <form asp-action="Index" method="get">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="tuKhoa" class="form-label">Từ khóa</label>
                                <input type="text" class="form-control" id="tuKhoa" name="tuKhoa" 
                                       value="@Model.TuKhoa" placeholder="Nhập tên sản phẩm...">
                            </div>
                            <div class="col-md-3">
                                <label for="giaTu" class="form-label">Giá từ (VNĐ)</label>
                                <input type="number" class="form-control" id="giaTu" name="giaTu" 
                                       value="@Model.GiaTu" placeholder="0" min="0">
                            </div>
                            <div class="col-md-3">
                                <label for="giaDen" class="form-label">Giá đến (VNĐ)</label>
                                <input type="number" class="form-control" id="giaDen" name="giaDen" 
                                       value="@Model.GiaDen" placeholder="100000000" min="0">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-search me-1"></i>Tìm kiếm
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Kết quả tìm kiếm -->
    <div class="row mb-3">
        <div class="col-12">
            @if (!string.IsNullOrEmpty(Model.TuKhoa) || Model.GiaTu.HasValue || Model.GiaDen.HasValue)
            {
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Tìm thấy <strong>@Model.DanhSachSanPham.Count</strong> sản phẩm
                    @if (!string.IsNullOrEmpty(Model.TuKhoa))
                    {
                        <span>với từ khóa "<strong>@Model.TuKhoa</strong>"</span>
                    }
                    @if (Model.GiaTu.HasValue || Model.GiaDen.HasValue)
                    {
                        <span>trong khoảng giá 
                            <strong>@((Model.GiaTu ?? 0).ToString("N0"))</strong> - 
                            <strong>@((Model.GiaDen ?? 100000000).ToString("N0"))</strong> VNĐ
                        </span>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Danh sách sản phẩm -->
    @if (!Model.DanhSachSanPham.Any())
    {
        <div class="row">
            <div class="col-12">
                <div class="alert alert-warning text-center">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <h5>Không tìm thấy sản phẩm nào</h5>
                    <p class="mb-0">Vui lòng thử lại với từ khóa hoặc khoảng giá khác.</p>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            @foreach (var sp in Model.DanhSachSanPham)
            {
                <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                    <div class="card h-100 shadow-sm product-card">
                        <!-- Hình ảnh sản phẩm -->
                        <div class="position-relative">
                            <img src="~/images/@(sp.Hinh ?? "default.jpg")" 
                                 class="card-img-top" 
                                 alt="@sp.TenHH" 
                                 style="height: 200px; object-fit: cover;">
                            
                            @if (sp.GiamGia.HasValue && sp.GiamGia > 0)
                            {
                                <span class="badge bg-danger position-absolute top-0 end-0 m-2">
                                    -@sp.GiamGia.Value.ToString("0")%
                                </span>
                            }
                        </div>

                        <!-- Thông tin sản phẩm -->
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title text-truncate" title="@sp.TenHH">@sp.TenHH</h6>
                            
                            <!-- Giá -->
                            <div class="price-section mb-2">
                                @if (sp.GiamGia.HasValue && sp.GiamGia > 0)
                                {
                                    <div class="text-muted text-decoration-line-through small">
                                        @sp.GiaGoc.ToString("N0") VNĐ
                                    </div>
                                    <div class="text-danger fw-bold">
                                        @((sp.DonGia ?? 0).ToString("N0")) VNĐ
                                    </div>
                                }
                                else
                                {
                                    <div class="text-danger fw-bold">
                                        @((sp.DonGia ?? 0).ToString("N0")) VNĐ
                                    </div>
                                }
                            </div>

                            <!-- Thông tin thêm -->
                            <div class="small text-muted mb-3">
                                <i class="fas fa-eye me-1"></i>@(sp.SoLanXem ?? 0) lượt xem
                                @if (sp.DanhGia.HasValue && sp.DanhGia > 0)
                                {
                                    <span class="ms-2">
                                        <i class="fas fa-star text-warning me-1"></i>@sp.DanhGia.Value.ToString("0.1")
                                    </span>
                                }
                            </div>

                            <!-- Nút hành động -->
                            <div class="mt-auto">
                                <div class="d-grid gap-2">
                                    <a asp-controller="HangHoa" 
                                       asp-action="ChiTiet" 
                                       asp-route-id="@sp.MaHH" 
                                       class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-info-circle me-1"></i>Chi tiết
                                    </a>
                                    
                                    <button type="button" 
                                            class="btn btn-primary btn-sm"
                                            onclick="themVaoGio(@sp.MaHH)">
                                        <i class="fas fa-cart-plus me-1"></i>Thêm vào giỏ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Pagination (nếu cần) -->
        @if (Model.DanhSachSanPham.Count > 12)
        {
            <div class="row mt-4">
                <div class="col-12 d-flex justify-content-center">
                    <nav aria-label="Phân trang sản phẩm">
                        <ul class="pagination">
                            <li class="page-item">
                                <a class="page-link" href="#" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        }
    }
</div>

@section Scripts {
    <script>
        function themVaoGio(maHH) {
            if (!@(User.Identity.IsAuthenticated ? "true" : "false")) {
                alert('Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng!');
                window.location.href = '/Account/Login';
                return;
            }

            $.ajax({
                url: '/GioHang/ThemVaoGio',
                type: 'POST',
                data: JSON.stringify({
                    maHH: maHH,
                    soLuong: 1,
                    baoHanh1: false,
                    baoHanh2: false
                }),
                contentType: 'application/json',
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        // Hiển thị thông báo thành công
                        showToast('Đã thêm sản phẩm vào giỏ hàng!', 'success');
                        
                        // Cập nhật số lượng giỏ hàng nếu có
                        if (response.soLuongGioHang) {
                            $('.cart-count').text(response.soLuongGioHang);
                        }
                    } else {
                        showToast(response.message || 'Có lỗi xảy ra!', 'error');
                    }
                },
                error: function() {
                    showToast('Có lỗi xảy ra khi thêm sản phẩm!', 'error');
                }
            });
        }

        function showToast(message, type) {
            // Tạo toast notification đơn giản
            const toast = $(`
                <div class="toast-notification ${type}" style="
                    position: fixed; 
                    top: 20px; 
                    right: 20px; 
                    z-index: 9999; 
                    padding: 15px 20px; 
                    border-radius: 5px; 
                    color: white; 
                    background-color: ${type === 'success' ? '#28a745' : '#dc3545'};
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                ">
                    ${message}
                </div>
            `);
            
            $('body').append(toast);
            
            setTimeout(() => {
                toast.fadeOut(() => toast.remove());
            }, 3000);
        }
    </script>
}

<style>
    .product-card {
        transition: transform 0.2s ease-in-out;
    }
    
    .product-card:hover {
        transform: translateY(-5px);
    }
    
    .price-section {
        min-height: 50px;
    }
</style>
